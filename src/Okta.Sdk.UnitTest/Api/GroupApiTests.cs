/*
 * Okta API
 *
 * Allows customers to easily access the Okta API
 *
 * The version of the OpenAPI document: 2.10.0
 * Contact: devex-public@okta.com
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

using System;
using System.Linq;
using System.Net;
using System.Threading.Tasks;
using FluentAssertions;
using Okta.Sdk.Api;
using Okta.Sdk.Client;
using Okta.Sdk.UnitTest.Internal;
using WireMock.RequestBuilders;
using WireMock.ResponseBuilders;
using WireMock.Server;
using Xunit;

namespace Okta.Sdk.UnitTest.Api
{
    /// <summary>
    ///  Class for testing GroupApi
    /// </summary>
    /// <remarks>
    /// This file is automatically generated by OpenAPI Generator (https://openapi-generator.tech).
    /// Please update the test case below to test the API endpoint.
    /// </remarks>
    public class GroupApiTests
    {
        private readonly WireMockServer _server;

        public GroupApiTests()
        {
            _server = WireMockServer.Start();
        }

        public void Dispose()
        {
            _server.Stop();
        }

        private void CreateStubReturningDelayedResponse()
        {
            _server.Given(
                    Request.Create().WithPath("/api/v1/groups*")
                )
                .RespondWith(
                    Response.Create()
                        .WithStatusCode(200)
                        .WithHeader("Content-Type", "text/json")
                        .WithBody(@"{}")
                        // this returns the response after a 5000ms delay
                        .WithDelay(TimeSpan.FromMilliseconds(5000))
                );
        }

        [Fact]
        public async Task ThrowOnTimeout()
        {
            var groupsApi = new GroupApi(new Configuration { OktaDomain = _server.Url!, Token = "foo", ConnectionTimeout = 1000, DisableOktaDomainCheck = true });

            CreateStubReturningDelayedResponse();

            await Assert.ThrowsAsync<TimeoutException>(async () => await groupsApi.GetGroupAsync("foo"));
            await Assert.ThrowsAsync<TimeoutException>(async () => await groupsApi.ListGroups().ToListAsync());
        }

        [Fact]
        public async Task ListApplicationTargetsForApplicationAdministratorRoleForGroup()
        {
            var rawResponse = @"[
                                    {
                                        ""name"": ""facebook"",
                                        ""displayName"": ""Facebook"",
                                        ""description"": ""Description"",
                                        ""status"": ""ACTIVE"",
                                        ""lastUpdated"": ""2017-07-19T23:37:37.000Z"",
                                        ""category"": ""SOCIAL"",
                                        ""verificationStatus"": ""OKTA_VERIFIED"",
                                        ""website"": ""http://www.facebook.com"",
                                        ""signOnModes"": [
                                            ""BROWSER_PLUGIN""
                                        ],
                                        ""_links"": {
                                            ""logo"": [
                                                {
                                                    ""name"": ""medium"",
                                                    ""href"": ""http://${yourOktaDomain}/assets/img/logos/facebook.e8215796628b5eaf687ba414ae245659.png"",
                                                    ""type"": ""image/png""
                                                }
                                            ],
                                            ""self"": {
                                                ""href"": ""http://${yourOktaDomain}/api/v1/catalog/apps/facebook""
                                            }
                                        }
                                    },
                                    {
                                        ""name"": ""24 Seven Office 0"",
                                        ""status"": ""ACTIVE"",
                                        ""id"": ""0oasrudLtMlzAsTxk0g3"",
                                        ""_links"": {
                                            ""self"": {
                                                ""href"": ""http://${yourOktaDomain}/api/v1/apps/0oasrudLtMlzAsTxk0g3""
                                            }
                                        }
                                    }
                                ]";

            var mockClient = new MockAsyncClient(rawResponse, HttpStatusCode.OK);
            var roleTargetApi = new RoleTargetApi(mockClient, new Configuration { BasePath = "https://foo.com" });

            var apps = await roleTargetApi.ListApplicationTargetsForApplicationAdministratorRoleForGroup("foo", "bar")
                .ToListAsync();

            mockClient.ReceivedPath.Should().StartWith("/api/v1/groups/{groupId}/roles/{roleId}/targets/catalog/apps");
            mockClient.ReceivedPathParams["groupId"].Should().Contain("foo");
            mockClient.ReceivedPathParams["roleId"].Should().Contain("bar");



            apps.Should().NotBeNullOrEmpty();
            apps.Should().HaveCount(2);
            apps.FirstOrDefault().Name.Should().Be("facebook");
            apps.FirstOrDefault().Status.Value.Should().Be("ACTIVE");
            apps.FirstOrDefault().Id.Should().BeNullOrEmpty();
            apps.FirstOrDefault().Description.Should().Be("Description");
            apps.FirstOrDefault().DisplayName.Should().Be("Facebook");
            apps.FirstOrDefault().Category.Should().Be("SOCIAL");
            apps.FirstOrDefault().VerificationStatus.Should().Be("OKTA_VERIFIED");
            apps.FirstOrDefault().Website.Should().Be("http://www.facebook.com");
            apps.FirstOrDefault().SignOnModes.Should().Contain("BROWSER_PLUGIN");

            apps[1].Name.Should().Be("24 Seven Office 0");
            apps[1].Status.Value.Should().Be("ACTIVE");
            apps[1].Id.Should().Be("0oasrudLtMlzAsTxk0g3");
        }

        [Fact]
        public async Task GetGroupWithCustomProperties()
        {

            var response = @"{
                               ""id"":""foo"",
                               ""created"":""2021-09-24T17:52:26.000Z"",
                               ""lastUpdated"":""2021-09-24T17:52:26.000Z"",
                               ""lastMembershipUpdated"":""2021-09-27T19:44:46.000Z"",
                               ""objectClass"":[
                                  ""okta:user_group""
                               ],
                               ""type"":""OKTA_GROUP"",
                               ""profile"":{
                                  ""name"":""Admins"",
                                  ""description"":""Admin Group"",
                                  ""customProp"":""customValue""
                               }
                            }";
            var mockClient = new MockAsyncClient(response, HttpStatusCode.OK);
            var groupApi = new GroupApi(mockClient, new Configuration { BasePath = "https://foo.com" });

            var retrievedGroup = await groupApi.GetGroupAsync("foo");

            retrievedGroup.Profile.AdditionalProperties["customProp"].Should().Be("customValue");
        }

        [Fact]
        public async Task AddApplicationTargetToAdminRoleGivenToGroup()
        {

            var mockClient = new MockAsyncClient(String.Empty, HttpStatusCode.OK);
            var roleTargetApi = new RoleTargetApi(mockClient, new Configuration { BasePath = "https://foo.com" });

            await roleTargetApi.AssignAppTargetToAdminRoleForGroupAsync("foo", "bar", "baz");

            mockClient.ReceivedPath.Should().StartWith("/api/v1/groups/{groupId}/roles/{roleId}/targets/catalog/apps/{appName}");
            mockClient.ReceivedPathParams["groupId"].Should().Contain("foo");
            mockClient.ReceivedPathParams["roleId"].Should().Contain("bar");
            mockClient.ReceivedPathParams["appName"].Should().Contain("baz");
        }

        [Fact]
        public async Task AddApplicationInstanceTargetToAppAdminRoleGivenToGroup()
        {
            var mockClient = new MockAsyncClient(String.Empty, HttpStatusCode.NoContent);
            var roleTargetApi = new RoleTargetApi(mockClient, new Configuration { BasePath = "https://foo.com" });


            await roleTargetApi.AssignAppInstanceTargetToAppAdminRoleForGroupAsync("foo", "bar", "baz", "bax");

            mockClient.ReceivedPath.Should().StartWith("/api/v1/groups/{groupId}/roles/{roleId}/targets/catalog/apps/{appName}/{appId}");
            mockClient.ReceivedPathParams["groupId"].Should().Contain("foo");
            mockClient.ReceivedPathParams["roleId"].Should().Contain("bar");
            mockClient.ReceivedPathParams["appName"].Should().Contain("baz");
            mockClient.ReceivedPathParams["appId"].Should().Contain("bax");
        }

        [Fact]
        public async Task RemoveApplicationTargetFromAdministratorRoleGivenToGroup()
        {
            var mockClient = new MockAsyncClient(String.Empty, HttpStatusCode.NoContent);
            var roleTargetApi = new RoleTargetApi(mockClient, new Configuration { BasePath = "https://foo.com" });

            await roleTargetApi.UnassignAppInstanceTargetToAppAdminRoleForGroupWithHttpInfoAsync("foo", "bar", "baz", "bax");

            mockClient.ReceivedPath.Should().StartWith("/api/v1/groups/{groupId}/roles/{roleId}/targets/catalog/apps/{appName}/{appId}");
            mockClient.ReceivedPathParams["groupId"].Should().Contain("foo");
            mockClient.ReceivedPathParams["roleId"].Should().Contain("bar");
            mockClient.ReceivedPathParams["appName"].Should().Contain("baz");
            mockClient.ReceivedPathParams["appId"].Should().Contain("bax");
        }

        [Fact]
        public async Task RemoveApplicationTargetFromApplicationAdministratorRoleGivenToGroup()
        {
            var mockClient = new MockAsyncClient(String.Empty, HttpStatusCode.NoContent);
            var roleTargetApi = new RoleTargetApi(mockClient, new Configuration { BasePath = "https://foo.com" });

            await roleTargetApi.UnassignAppTargetToAdminRoleForGroupAsync("foo", "bar", "baz");

            mockClient.ReceivedPath.Should().StartWith("/api/v1/groups/{groupId}/roles/{roleId}/targets/catalog/apps/{appName}");
            mockClient.ReceivedPathParams["groupId"].Should().Contain("foo");
            mockClient.ReceivedPathParams["roleId"].Should().Contain("bar");
            mockClient.ReceivedPathParams["appName"].Should().Contain("baz");
        }
    }
}