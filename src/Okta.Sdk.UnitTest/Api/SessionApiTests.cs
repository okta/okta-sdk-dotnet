// <copyright file="SessionApiTests.cs" company="Okta, Inc">
// Copyright (c) 2014-present Okta, Inc. All rights reserved.
// Licensed under the Apache 2.0 license. See the LICENSE file in the project root for full license information.
// </copyright>

/*
 * Okta API
 *
 * Allows customers to easily access the Okta API
 *
 * The version of the OpenAPI document: 5.1.0
 * Contact: devex-public@okta.com
 * Generated by: https://github.com/openapitools/openapi-generator.git
 */

using System;
using System.Net;
using System.Threading.Tasks;
using FluentAssertions;
using Okta.Sdk.Api;
using Okta.Sdk.Client;
using Okta.Sdk.Model;
using Okta.Sdk.UnitTest.Internal;
using Xunit;

namespace Okta.Sdk.UnitTest.Api
{
    /// <summary>
    ///  Class for testing SessionApi
    /// </summary>
    public class SessionApiTests
    {
        #region CreateSession Tests

        [Fact]
        public async Task CreateSession_WithValidSessionToken_ReturnsSession()
        {
            // Arrange
            var sessionId = "session-123";
            var userId = "user-456";
            var loginValue = "test@example.com";
            var sessionToken = "test-session-token";
            
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": """ + userId + @""",
                ""login"": """ + loginValue + @""",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var request = new CreateSessionRequest
            {
                SessionToken = sessionToken
            };

            // Act
            var session = await sessionApi.CreateSessionAsync(request);

            // Assert
            session.Should().NotBeNull();
            session.Id.Should().Be(sessionId);
            session.UserId.Should().Be(userId);
            session.Login.Should().Be(loginValue);
            session.Status.Should().Be(SessionStatus.ACTIVE);

            mockClient.ReceivedPath.Should().Be("/api/v1/sessions");
            mockClient.ReceivedBody.Should().Contain(sessionToken);
        }

        [Fact]
        public async Task CreateSession_WithAdditionalFields_SetsFieldsCorrectly()
        {
            // Arrange
            var responseJson = @"{
                ""id"": ""session-123"",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd"", ""mfa""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": true
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var request = new CreateSessionRequest
            {
                SessionToken = "test-token"
            };

            // Act
            var session = await sessionApi.CreateSessionAsync(request);

            // Assert
            session.Should().NotBeNull();
            mockClient.ReceivedBody.Should().Contain("test-token");
        }

        [Fact]
        public async Task CreateSession_CallsCorrectEndpoint()
        {
            // Arrange
            var responseJson = @"{
                ""id"": ""session-123"",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var request = new CreateSessionRequest
            {
                SessionToken = "test-token"
            };

            // Act
            await sessionApi.CreateSessionAsync(request);

            // Assert
            mockClient.ReceivedPath.Should().Be("/api/v1/sessions");
        }

        #endregion

        #region GetSession Tests

        [Fact]
        public async Task GetSession_WithValidId_ReturnsSession()
        {
            // Arrange
            var sessionId = "session-abc-123";
            var userId = "user-xyz-789";
            var loginValue = "john.doe@example.com";
            
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": """ + userId + @""",
                ""login"": """ + loginValue + @""",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T15:30:00.000Z"",
                ""createdAt"": ""2025-10-05T15:30:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T15:30:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T15:30:00.000Z"",
                ""amr"": [""pwd"", ""swk""],
                ""idp"": {
                    ""id"": ""idp-okta-123"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": true
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var session = await sessionApi.GetSessionAsync(sessionId);

            // Assert
            session.Should().NotBeNull();
            session.Id.Should().Be(sessionId);
            session.UserId.Should().Be(userId);
            session.Login.Should().Be(loginValue);
            session.Status.Should().Be(SessionStatus.ACTIVE);
            
            mockClient.ReceivedPath.Should().StartWith("/api/v1/sessions/{sessionId}");
            mockClient.ReceivedPathParams["sessionId"].Should().Contain(sessionId);
        }

        [Fact]
        public async Task GetSession_WithMFARequired_ReturnsMFARequiredStatus()
        {
            // Arrange
            var sessionId = "session-mfa-123";
            
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""MFA_REQUIRED"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": true
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var session = await sessionApi.GetSessionAsync(sessionId);

            // Assert
            session.Should().NotBeNull();
            session.Status.Should().Be(SessionStatus.MFAREQUIRED);
        }

        [Fact]
        public async Task GetSession_CallsCorrectEndpointWithPathParameter()
        {
            // Arrange
            var sessionId = "test-session-id-789";
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            await sessionApi.GetSessionAsync(sessionId);

            // Assert
            mockClient.ReceivedPath.Should().StartWith("/api/v1/sessions/{sessionId}");
            mockClient.ReceivedPathParams.Should().ContainKey("sessionId");
            mockClient.ReceivedPathParams["sessionId"].Should().Contain(sessionId);
        }

        #endregion

        #region RefreshSession Tests

        [Fact]
        public async Task RefreshSession_WithValidId_ReturnsRefreshedSession()
        {
            // Arrange
            var sessionId = "session-refresh-123";
            var newExpiry = "2025-10-06T14:00:00.000Z";
            
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": """ + newExpiry + @""",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var session = await sessionApi.RefreshSessionAsync(sessionId);

            // Assert
            session.Should().NotBeNull();
            session.Id.Should().Be(sessionId);
            session.Status.Should().Be(SessionStatus.ACTIVE);
            
            mockClient.ReceivedPath.Should().StartWith("/api/v1/sessions/{sessionId}/lifecycle/refresh");
            mockClient.ReceivedPathParams["sessionId"].Should().Contain(sessionId);
        }

        [Fact]
        public async Task RefreshSession_CallsCorrectLifecycleEndpoint()
        {
            // Arrange
            var sessionId = "session-lifecycle-456";
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T14:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            await sessionApi.RefreshSessionAsync(sessionId);

            // Assert
            mockClient.ReceivedPath.Should().Contain("/lifecycle/refresh");
            mockClient.ReceivedPathParams["sessionId"].Should().Contain(sessionId);
        }

        #endregion

        #region RevokeSession Tests

        [Fact]
        public async Task RevokeSession_WithValidId_CompletesSuccessfully()
        {
            // Arrange
            var sessionId = "session-to-revoke-123";
            var mockClient = new MockAsyncClient(string.Empty, HttpStatusCode.NoContent);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            await sessionApi.RevokeSessionAsync(sessionId);

            // Assert
            mockClient.ReceivedPath.Should().StartWith("/api/v1/sessions/{sessionId}");
            mockClient.ReceivedPathParams["sessionId"].Should().Contain(sessionId);
        }

        [Fact]
        public async Task RevokeSession_CallsDeleteEndpoint()
        {
            // Arrange
            var sessionId = "session-delete-789";
            var mockClient = new MockAsyncClient(string.Empty, HttpStatusCode.NoContent);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            await sessionApi.RevokeSessionAsync(sessionId);

            // Assert
            mockClient.ReceivedPath.Should().StartWith("/api/v1/sessions/{sessionId}");
            mockClient.ReceivedPathParams.Should().ContainKey("sessionId");
        }

        #endregion

        #region Session Model Tests

        [Fact]
        public async Task Session_AuthenticationMethod_ParsesCorrectly()
        {
            // Arrange
            var responseJson = @"{
                ""id"": ""session-123"",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd"", ""mfa"", ""otp""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": true
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var session = await sessionApi.GetSessionAsync("session-123");

            // Assert
            session.Amr.Should().NotBeNull();
            session.Amr.Should().HaveCount(3);
            session.Amr.Should().Contain(SessionAuthenticationMethod.Pwd);
            session.Amr.Should().Contain(SessionAuthenticationMethod.Mfa);
            session.Amr.Should().Contain(SessionAuthenticationMethod.Otp);
        }

        [Fact]
        public async Task Session_IdentityProvider_ParsesCorrectly()
        {
            // Arrange
            var responseJson = @"{
                ""id"": ""session-123"",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""custom-idp-123"",
                    ""type"": ""FEDERATION""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var session = await sessionApi.GetSessionAsync("session-123");

            // Assert
            session.Idp.Should().NotBeNull();
            session.Idp.Id.Should().Be("custom-idp-123");
            session.Idp.Type.Should().Be(SessionIdentityProviderType.FEDERATION);
        }

        [Fact]
        public async Task Session_AllStatuses_ParseCorrectly()
        {
            // Test ACTIVE status
            var activeJson = @"{
                ""id"": ""session-1"",
                ""userId"": ""user-1"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(activeJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var activeSession = await sessionApi.GetSessionAsync("session-1");
            activeSession.Status.Should().Be(SessionStatus.ACTIVE);

            // Test MFA_REQUIRED status
            var mfaJson = @"{
                ""id"": ""session-2"",
                ""userId"": ""user-2"",
                ""login"": ""test@example.com"",
                ""status"": ""MFA_REQUIRED"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": true
            }";

            mockClient = new MockAsyncClient(mfaJson);
            sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var mfaSession = await sessionApi.GetSessionAsync("session-2");
            mfaSession.Status.Should().Be(SessionStatus.MFAREQUIRED);

            // Test MFA_ENROLL status
            var enrollJson = @"{
                ""id"": ""session-3"",
                ""userId"": ""user-3"",
                ""login"": ""test@example.com"",
                ""status"": ""MFA_ENROLL"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            mockClient = new MockAsyncClient(enrollJson);
            sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var enrollSession = await sessionApi.GetSessionAsync("session-3");
            enrollSession.Status.Should().Be(SessionStatus.MFAENROLL);
        }

        [Fact]
        public async Task Session_Timestamps_ParseCorrectly()
        {
            // Arrange
            var responseJson = @"{
                ""id"": ""session-123"",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:30:45.123Z"",
                ""createdAt"": ""2025-10-05T10:15:30.456Z"",
                ""lastPasswordVerification"": ""2025-10-05T09:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T11:30:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var session = await sessionApi.GetSessionAsync("session-123");

            // Assert
            session.ExpiresAt.Should().BeAfter(DateTimeOffset.MinValue);
            session.CreatedAt.Should().BeAfter(DateTimeOffset.MinValue);
            session.LastPasswordVerification.Should().BeAfter(DateTimeOffset.MinValue);
            session.LastFactorVerification.Should().BeAfter(DateTimeOffset.MinValue);
        }

        #endregion

        #region Error Handling Tests

        [Fact]
        public async Task GetSession_WithInvalidId_ThrowsApiException()
        {
            // Arrange
            var errorJson = @"{
                ""errorCode"": ""E0000007"",
                ""errorSummary"": ""Not found: Resource not found: invalid-session-id (Session)"",
                ""errorLink"": ""E0000007"",
                ""errorId"": ""error-id-123""
            }";

            var mockClient = new MockAsyncClient(errorJson, HttpStatusCode.NotFound);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act & Assert
            var exception = await Assert.ThrowsAsync<ApiException>(
                async () => await sessionApi.GetSessionAsync("invalid-session-id")
            );

            exception.ErrorCode.Should().Be((int)HttpStatusCode.NotFound);
        }

        [Fact]
        public async Task CreateSession_WithInvalidToken_ThrowsApiException()
        {
            // Arrange
            var errorJson = @"{
                ""errorCode"": ""E0000011"",
                ""errorSummary"": ""Invalid token provided"",
                ""errorLink"": ""E0000011"",
                ""errorId"": ""error-id-456""
            }";

            var mockClient = new MockAsyncClient(errorJson, HttpStatusCode.Unauthorized);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            var request = new CreateSessionRequest
            {
                SessionToken = "invalid-token"
            };

            // Act & Assert
            var exception = await Assert.ThrowsAsync<ApiException>(
                async () => await sessionApi.CreateSessionAsync(request)
            );

            exception.ErrorCode.Should().Be((int)HttpStatusCode.Unauthorized);
        }

        #endregion

        #region HttpInfo Tests

        [Fact]
        public async Task GetSessionWithHttpInfo_ReturnsApiResponse()
        {
            // Arrange
            var sessionId = "session-http-info-123";
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T12:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var apiResponse = await sessionApi.GetSessionWithHttpInfoAsync(sessionId);

            // Assert
            apiResponse.Should().NotBeNull();
            apiResponse.StatusCode.Should().Be(HttpStatusCode.OK);
            apiResponse.Data.Should().NotBeNull();
            apiResponse.Data.Id.Should().Be(sessionId);
        }

        [Fact]
        public async Task RefreshSessionWithHttpInfo_ReturnsApiResponse()
        {
            // Arrange
            var sessionId = "session-refresh-http-info-456";
            var responseJson = @"{
                ""id"": """ + sessionId + @""",
                ""userId"": ""user-456"",
                ""login"": ""test@example.com"",
                ""status"": ""ACTIVE"",
                ""expiresAt"": ""2025-10-06T14:00:00.000Z"",
                ""createdAt"": ""2025-10-05T12:00:00.000Z"",
                ""lastPasswordVerification"": ""2025-10-05T12:00:00.000Z"",
                ""lastFactorVerification"": ""2025-10-05T12:00:00.000Z"",
                ""amr"": [""pwd""],
                ""idp"": {
                    ""id"": ""idp-789"",
                    ""type"": ""OKTA""
                },
                ""mfaActive"": false
            }";

            var mockClient = new MockAsyncClient(responseJson);
            var sessionApi = new SessionApi(mockClient, new Configuration { BasePath = "https://test.okta.com" });

            // Act
            var apiResponse = await sessionApi.RefreshSessionWithHttpInfoAsync(sessionId);

            // Assert
            apiResponse.Should().NotBeNull();
            apiResponse.StatusCode.Should().Be(HttpStatusCode.OK);
            apiResponse.Data.Should().NotBeNull();
            apiResponse.Data.Id.Should().Be(sessionId);
        }

        #endregion
    }
}
