{{>partial_header}}

using System;
using System.Collections.Generic;
using System.Linq;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;

namespace {{packageName}}.Model
{
    /// <summary>
    /// Custom JSON converter for Group that uses objectClass to determine the correct GroupProfile type.
    /// 
    /// The Okta API uses objectClass as the discriminator:
    /// - "okta:user_group" → OktaUserGroupProfile
    /// - "okta:windows_security_principal" → OktaActiveDirectoryGroupProfile
    /// </summary>
    public class GroupJsonConverter : JsonConverter<Group>
    {
        private const string OktaUserGroupObjectClass = "okta:user_group";
        private const string WindowsSecurityPrincipalObjectClass = "okta:windows_security_principal";

        /// <summary>
        /// Writes the JSON representation of the Group object.
        /// </summary>
        public override void WriteJson(JsonWriter writer, Group value, JsonSerializer serializer)
        {
            // Use default serialization for writing
            var token = JToken.FromObject(value, JsonSerializer.CreateDefault(new JsonSerializerSettings
            {
                ContractResolver = serializer.ContractResolver,
                NullValueHandling = serializer.NullValueHandling,
                Converters = serializer.Converters.Where(c => !(c is GroupJsonConverter)).ToList()
            }));
            token.WriteTo(writer);
        }

        /// <summary>
        /// Reads the JSON representation of the Group object, using objectClass to determine the profile type.
        /// </summary>
        public override Group ReadJson(JsonReader reader, Type objectType, Group existingValue, bool hasExistingValue, JsonSerializer serializer)
        {
            if (reader.TokenType == JsonToken.Null)
            {
                return null;
            }

            var jsonObject = JObject.Load(reader);

            // Determine profile type based on objectClass
            var objectClassArray = jsonObject["objectClass"]?.ToObject<List<string>>();
            var isAdGroup = objectClassArray?.Contains(WindowsSecurityPrincipalObjectClass) == true;

            // Create the Group object without the Profile first
            var group = new Group();

            // Populate all properties except Profile using a serializer without this converter
            var tempSerializer = JsonSerializer.CreateDefault(new JsonSerializerSettings
            {
                ContractResolver = serializer.ContractResolver,
                NullValueHandling = serializer.NullValueHandling,
                DateParseHandling = DateParseHandling.DateTimeOffset
            });

            // Manually set properties from the JSON
            if (jsonObject["created"] != null)
            {
                var createdProperty = typeof(Group).GetProperty("Created");
                createdProperty?.SetValue(group, jsonObject["created"].ToObject<DateTimeOffset>(tempSerializer));
            }

            if (jsonObject["id"] != null)
            {
                var idProperty = typeof(Group).GetProperty("Id");
                idProperty?.SetValue(group, jsonObject["id"].ToObject<string>());
            }

            if (jsonObject["lastMembershipUpdated"] != null)
            {
                var lastMembershipUpdatedProperty = typeof(Group).GetProperty("LastMembershipUpdated");
                lastMembershipUpdatedProperty?.SetValue(group, jsonObject["lastMembershipUpdated"].ToObject<DateTimeOffset>(tempSerializer));
            }

            if (jsonObject["lastUpdated"] != null)
            {
                var lastUpdatedProperty = typeof(Group).GetProperty("LastUpdated");
                lastUpdatedProperty?.SetValue(group, jsonObject["lastUpdated"].ToObject<DateTimeOffset>(tempSerializer));
            }

            if (jsonObject["objectClass"] != null)
            {
                var objectClassProperty = typeof(Group).GetProperty("ObjectClass");
                objectClassProperty?.SetValue(group, objectClassArray);
            }

            if (jsonObject["type"] != null)
            {
                var typeProperty = typeof(Group).GetProperty("Type");
                typeProperty?.SetValue(group, jsonObject["type"].ToObject<GroupType>(tempSerializer));
            }

            if (jsonObject["_embedded"] != null)
            {
                var embeddedProperty = typeof(Group).GetProperty("Embedded");
                embeddedProperty?.SetValue(group, jsonObject["_embedded"].ToObject<Dictionary<string, object>>(tempSerializer));
            }

            if (jsonObject["_links"] != null)
            {
                var linksProperty = typeof(Group).GetProperty("Links");
                linksProperty?.SetValue(group, jsonObject["_links"].ToObject<GroupLinks>(tempSerializer));
            }

            if (jsonObject["source"] != null)
            {
                var sourceProperty = typeof(Group).GetProperty("Source");
                sourceProperty?.SetValue(group, jsonObject["source"].ToObject<GroupSource>(tempSerializer));
            }

            // Now handle the profile with the correct type based on objectClass
            if (jsonObject["profile"] != null)
            {
                var profileProperty = typeof(Group).GetProperty("Profile");
                var profileJson = jsonObject["profile"].ToString();

                if (isAdGroup)
                {
                    var adProfile = JsonConvert.DeserializeObject<OktaActiveDirectoryGroupProfile>(profileJson, GroupProfile.AdditionalPropertiesSerializerSettings);
                    profileProperty?.SetValue(group, new GroupProfile(adProfile));
                }
                else
                {
                    var userProfile = JsonConvert.DeserializeObject<OktaUserGroupProfile>(profileJson, GroupProfile.AdditionalPropertiesSerializerSettings);
                    profileProperty?.SetValue(group, new GroupProfile(userProfile));
                }
            }

            return group;
        }
    }
}
